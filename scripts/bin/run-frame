#!/bin/sh
set -eux
if [ "$1" = "--help" ]; then set +x; fi

XDG_RUNTIME_DIR=$(dirname "$XDG_RUNTIME_DIR")
export XDG_RUNTIME_DIR
mkdir -p "$XDG_RUNTIME_DIR" -m 700

# If there's an existing Wayland server, we're likely on a Wayland desktop
if [ -n "${WAYLAND_DISPLAY:-}" ] && [ -e "$XDG_RUNTIME_DIR/$WAYLAND_DISPLAY" ]
then
  # Allow Mir to select an uncontested WAYLAND_DISPLAY
  unset WAYLAND_DISPLAY
fi

# Use hack in snapd for proprietary nVidia drivers mounts the drivers in
# /var/lib/snapd/lib/gl that needs to be in LD_LIBRARY_PATH
# Without that OpenGL using apps do not work with the nVidia drivers
if [ -d /var/lib/snapd/lib/glvnd/egl_vendor.d ]; then
  __EGL_VENDOR_LIBRARY_DIRS=/var/lib/snapd/lib/glvnd/egl_vendor.d:${__EGL_VENDOR_LIBRARY_DIRS}
  LD_LIBRARY_PATH=/var/lib/snapd/lib/gl:/var/lib/snapd/lib/gl/vdpau:${LD_LIBRARY_PATH}
fi

exec "$@"
